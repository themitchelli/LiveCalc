---
apiVersion: v1
kind: ConfigMap
metadata:
  name: keda-config
  namespace: livecalc-system
data:
  # Scaling configuration
  pollingInterval: "15"  # Check queue every 15 seconds
  cooldownPeriod: "60"   # Wait 60s before scaling to zero
  minReplicaCount: "0"   # Scale to zero when idle
  maxReplicaCount: "100" # Cap at 100 pods
  targetQueueLength: "10" # Each pod handles 10 jobs

---
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: livecalc-worker-scaler
  namespace: livecalc-system
  labels:
    app: livecalc-worker
    managed-by: keda
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: livecalc-worker

  # Scaling behavior
  pollingInterval: 15   # Check Redis queue every 15 seconds
  cooldownPeriod: 60    # Wait 60s after last trigger before scaling to zero
  minReplicaCount: 0    # Scale to zero when queue is empty
  maxReplicaCount: 100  # Maximum 100 worker pods

  # Fallback replicas when scaler is not available
  fallback:
    failureThreshold: 3
    replicas: 1

  # Advanced scaling policies
  advanced:
    restoreToOriginalReplicaCount: false
    horizontalPodAutoscalerConfig:
      behavior:
        scaleDown:
          stabilizationWindowSeconds: 60  # Wait 60s to ensure queue is stable
          policies:
            - type: Percent
              value: 50
              periodSeconds: 30  # Scale down by 50% every 30s
            - type: Pods
              value: 5
              periodSeconds: 30  # Or 5 pods every 30s (whichever is faster)
        scaleUp:
          stabilizationWindowSeconds: 0  # Scale up immediately
          policies:
            - type: Percent
              value: 100
              periodSeconds: 15  # Double capacity every 15s
            - type: Pods
              value: 10
              periodSeconds: 15  # Or add 10 pods every 15s

  # Triggers for scaling
  triggers:
    # Redis queue length trigger
    - type: redis
      metadata:
        # Redis connection (using TriggerAuthentication for credentials)
        addressFromEnv: REDIS_HOST
        passwordFromEnv: REDIS_PASSWORD
        databaseIndex: "0"

        # Query for QUEUED jobs (sorted set)
        # Count jobs in 'jobs:QUEUED' sorted set
        listName: jobs:QUEUED
        listLength: "10"  # Target: 10 jobs per pod

        # Enable TLS for Azure Cache for Redis
        enableTLS: "true"

    # Fallback to CPU-based scaling if Redis is unavailable
    - type: cpu
      metricType: Utilization
      metadata:
        value: "70"  # Scale when CPU > 70%

---
apiVersion: keda.sh/v1alpha1
kind: TriggerAuthentication
metadata:
  name: redis-trigger-auth
  namespace: livecalc-system
spec:
  # Use Azure Key Vault for Redis credentials
  azureKeyVault:
    vaultUri: https://livecalc-keyvault.vault.azure.net/
    credentials:
      clientId: livecalc-keda-identity  # Managed Identity
    secrets:
      - parameter: password
        name: redis-password
        version: ""  # Latest version

  # Fallback to Kubernetes Secret if Key Vault unavailable
  secretTargetRef:
    - parameter: password
      name: redis-credentials
      key: password

---
apiVersion: v1
kind: Secret
metadata:
  name: redis-credentials
  namespace: livecalc-system
type: Opaque
stringData:
  # Placeholder - actual password injected via CI/CD or Azure Key Vault
  password: ""  # Will be populated by deployment pipeline

---
# ConfigMap for environment variables
apiVersion: v1
kind: ConfigMap
metadata:
  name: worker-env-config
  namespace: livecalc-system
data:
  REDIS_HOST: "livecalc-redis.redis.cache.windows.net:6380"
  REDIS_DB: "0"
  LOG_LEVEL: "INFO"

  # Warm pool configuration
  WARM_POOL_ENABLED: "false"
  WARM_POOL_SIZE: "0"
  WARM_POOL_TIMEOUT_MINUTES: "30"

---
# Updated worker deployment to support KEDA scaling
apiVersion: apps/v1
kind: Deployment
metadata:
  name: livecalc-worker
  namespace: livecalc-system
  labels:
    app: livecalc-worker
    version: v1
spec:
  # Initial replica count (KEDA will override this)
  replicas: 0

  selector:
    matchLabels:
      app: livecalc-worker

  template:
    metadata:
      labels:
        app: livecalc-worker
        version: v1
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9090"
        prometheus.io/path: "/metrics"

    spec:
      # Managed Identity for Azure Key Vault access
      serviceAccountName: livecalc-worker-sa

      # Graceful shutdown
      terminationGracePeriodSeconds: 120

      containers:
        - name: worker
          image: livecalc.azurecr.io/livecalc-worker:latest
          imagePullPolicy: Always

          # Environment variables
          env:
            - name: REDIS_HOST
              valueFrom:
                configMapKeyRef:
                  name: worker-env-config
                  key: REDIS_HOST
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: redis-credentials
                  key: password
            - name: REDIS_DB
              valueFrom:
                configMapKeyRef:
                  name: worker-env-config
                  key: REDIS_DB
            - name: LOG_LEVEL
              valueFrom:
                configMapKeyRef:
                  name: worker-env-config
                  key: LOG_LEVEL
            - name: WARM_POOL_ENABLED
              valueFrom:
                configMapKeyRef:
                  name: worker-env-config
                  key: WARM_POOL_ENABLED
            - name: WARM_POOL_SIZE
              valueFrom:
                configMapKeyRef:
                  name: worker-env-config
                  key: WARM_POOL_SIZE
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace

          # Resource limits for cost control
          resources:
            requests:
              memory: "2Gi"
              cpu: "1000m"
            limits:
              memory: "4Gi"
              cpu: "2000m"

          # Health checks
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3

          readinessProbe:
            httpGet:
              path: /ready
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 3

          # Graceful shutdown handler
          lifecycle:
            preStop:
              exec:
                command: ["/bin/sh", "-c", "sleep 10"]

          ports:
            - containerPort: 8080
              name: http
              protocol: TCP
            - containerPort: 9090
              name: metrics
              protocol: TCP

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: livecalc-worker-sa
  namespace: livecalc-system
  annotations:
    azure.workload.identity/client-id: "00000000-0000-0000-0000-000000000000"  # Replace with actual Managed Identity Client ID

---
# HorizontalPodAutoscaler (managed by KEDA)
# This is created automatically by KEDA ScaledObject, but shown here for reference
# apiVersion: autoscaling/v2
# kind: HorizontalPodAutoscaler
# metadata:
#   name: keda-hpa-livecalc-worker-scaler
#   namespace: livecalc-system
# spec:
#   scaleTargetRef:
#     apiVersion: apps/v1
#     kind: Deployment
#     name: livecalc-worker
#   minReplicas: 0
#   maxReplicas: 100
#   metrics:
#     - type: External
#       external:
#         metric:
#           name: s0-redis-jobs_QUEUED
#         target:
#           type: AverageValue
#           averageValue: "10"
